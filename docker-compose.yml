services:
  nginx:
    image: nginx:1.27-alpine
    ports:
      - "8080:80"
    volumes:
      - ./app/symfony:/var/www/html:rw
      - ./app/docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./app/docker:/var/www/docker:ro
      - videos_data:/var/www/html/public/videos
    depends_on:
      - php

  php:
    build:
      context: ./app
      dockerfile: Dockerfile
    environment:
      APP_ENV: dev
      DATABASE_URL: "mysql://app:app@mysql:3306/app?serverVersion=8.0"
      MESSENGER_TRANSPORT_DSN: "amqp://guest:guest@rabbitmq:5672/%2f/messages"
      MESSENGER_FAILURE_TRANSPORT_DSN: "amqp://guest:guest@rabbitmq:5672/%2f/failed"
      BASE_PUBLIC_URL: "http://localhost:8080"
      WORK_DIR: "/var/www/html/var/work"
      VEO_LOCATION: "europe-west4"
      VEO_MODEL_ID: "veo-2.0-generate-001"
      GCP_VEO_MODEL_ID: "veo-2.0-generate-001"
      VEO_OUTPUT_GCS: "gs://floorfy-veo-storage/veo-output/"
      ANIMATOR_DRIVER: "veo"
      GOOGLE_APPLICATION_CREDENTIALS: /run/secrets/gcp-sa.json
      GCP_PROJECT_ID: floorfy-test-483313
      GCP_VERTEX_LOCATION: us-central1
      GCP_GCS_BUCKET: floorfy-veo-storage
      COMPOSER_HOME: /tmp/composer
    entrypoint: ["/bin/sh", "/var/www/docker/entrypoint-php.sh"]
    secrets:
      - gcp-sa.json
    volumes:
      - ./app/symfony:/var/www/html
      - work_data:/var/www/html/var/work
      - ./secrets/gcp-sa.json:/run/secrets/gcp-sa.json:ro
      - ./app/docker:/var/www/docker:ro
      - videos_data:/var/www/html/public/videos
    depends_on:
      - mysql
      - rabbitmq

  worker:
    build:
      context: ./app
      dockerfile: Dockerfile
    environment:
      APP_UID: "1000"
      APP_GID: "1000"
      APP_ENV: dev
      DATABASE_URL: "mysql://app:app@mysql:3306/app?serverVersion=8.0"
      MESSENGER_TRANSPORT_DSN: "amqp://guest:guest@rabbitmq:5672/%2f/messages"
      MESSENGER_FAILURE_TRANSPORT_DSN: "amqp://guest:guest@rabbitmq:5672/%2f/failed"
      BASE_PUBLIC_URL: "http://nginx"
      WORK_DIR: "/var/www/html/var/work"
      GOOGLE_APPLICATION_CREDENTIALS: /run/secrets/gcp-sa.json
      GCP_PROJECT_ID: floorfy-test-483313
      GCP_VERTEX_LOCATION: us-central1
      GCP_GCS_BUCKET: floorfy-veo-storage
      # Veo (Vertex AI)
      VEO_LOCATION: "europe-west4"
      VEO_MODEL_ID: "veo-2.0-generate-001"
      GCP_VEO_MODEL_ID: "veo-2.0-generate-001"
      VEO_OUTPUT_GCS: "gs://floorfy-veo-storage/veo-output/"
      ANIMATOR_DRIVER: "veo"
    entrypoint: ["/bin/sh", "/var/www/docker/entrypoint-worker.sh"]
    volumes:
      - ./app/symfony:/var/www/html
      - work_data:/var/www/html/var/work
      - ./secrets/gcp-sa.json:/run/secrets/gcp-sa.json:ro
      - ./app/docker:/var/www/docker:ro
      - videos_data:/var/www/html/public/videos
    depends_on:
      - php
      - rabbitmq
      - mysql

  mysql:
    image: mysql:8.0
    environment:
      MYSQL_DATABASE: app
      MYSQL_USER: app
      MYSQL_PASSWORD: app
      MYSQL_ROOT_PASSWORD: root
    ports:
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql

  rabbitmq:
    image: rabbitmq:3.13-management
    ports:
      - "5672:5672"
      - "15672:15672"

secrets:
  gcp-sa.json:
    file: ./secrets/gcp-sa.json

volumes:
  mysql_data:
  video_data:
  videos_data:
  work_data:
